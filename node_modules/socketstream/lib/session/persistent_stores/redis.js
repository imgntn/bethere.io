var key, redis, oneDay;

redis = require('redis');

oneDay = 86400;

exports.init = function(config) {
  var conn, host, options, port;
  if (config == null) config = {};
  port = config.redis && config.redis.port || 6379;
  host = config.redis && config.redis.host || "127.0.0.1";
  options = config.redis && config.redis.options || {};
  conn = redis.createClient(port, host, options);
  return {
    lookup: function(sessionId, cb) {
      return conn.get(key(sessionId), function(err, data) {
        var obj;
        obj = JSON.parse(data);
        return cb(obj);
      });
    },
    store: function(sessionId, obj, cb) {
      var data, maxAge, ttl;
      data = JSON.stringify(obj);
      maxAge = obj.cookie.maxAge;
      ttl = 'number' === typeof maxAge ? maxAge / 1000 | 0 : oneDay;
      conn.setex(key(sessionId), ttl, data, function(err, data) {
        return cb(obj);
      });
    }
  };
};

key = function(id) {
  return "ss:session:" + id;
};
